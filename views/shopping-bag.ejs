<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Bag</title>
</head>

<body>
    <!-- --------------------------------------------------------------------------------------------- -->
    <nav class="navbar">
        
    </nav>
    <!-- --------------------------------------------------------------------------------------------- -->


    <section class="bestseller">
        
        <h1>test</h1>
        <h3>SHOPPING BAG</h3>

        <div class="product-grid">

        </div>

        

    </section>

    <div class="all-continue">

        <div class="total-price">
             <span id="total" class="span">TOTAL : 3390</span>
        </div>
        
        <button class="button" onclick="goToPayment()">CONTINUE</button>


    </div>

    <footer class="footer">
        <div class="footer-column">
            <h4>ABOUT US</h4>
            <p >CAREERS</p>
            <p >FAQs</p>
            <p >RETURNS / EXCHANGES</p>
            <p >CONTACT US</p>
            <p >PRIVACY POLICY</p>
            <p >SHOP FASTER WITH THE APP</p>
        </div>

        <div class="footer-column">
            <h4>SIGN UP AND SAVE</h4>
            <p>Subscribe to get special offers, free giveaways</p>
    
        </div>

        <div class="footer-column">
            <h4>STORE LOCATION</h4>
            <p><strong>LAHORE</strong></p>
            <p>22-A, Block K Gulberg-II Lahore, Pakistan</p>
            <p><strong>EMPORIUM MALL</strong></p>
            <p>T01, Level 3</p>
            <p><strong>ISLAMABAD</strong></p>
            <p>Sumbal Rd, F-10 Markaz F10/4 Islamabad</p>
            <p><strong>KARACHI</strong></p>
            <p>LAMA at the mezzanine - Allure Beauty, Dolmen Mall Clifton</p>
        </div>
    </footer>

    <div class="footer-bottom">
        © 2024 Factio
    </div>
   
    
  

<script>
 
        document.addEventListener("DOMContentLoaded", function () {
            // 1️⃣ JSON ของสินค้าที่อยู่ในตะกร้า
            const cartItems =<%- JSON.stringify(cartItems) %>; 


    
            const productGrid = document.querySelector(".product-grid");
            const totalElement = document.getElementById("total");
    
            // 2️⃣ ฟังก์ชันสร้าง HTML ของสินค้าแต่ละชิ้น
            function renderCart() {
                productGrid.innerHTML = ""; // เคลียร์สินค้าก่อนรีเรนเดอร์ใหม่
                cartItems.forEach(item => {
                    const productHTML = `
                        <div class="product-card" data-id="${item.product_id}">
                            <img src="${item.image_url}" alt="${item.name}">
                            <p>${item.name}</p>
                            <span class="price" data-price="${item.price}">$ ${item.price}</span>
                            <div class="quantity-control">
                                <button class="decrease">-</button>
                                <span class="quantity">${item.quantity}</span>
                                <button class="increase">+</button>
                            </div>
                        </div>
                    `;
                    productGrid.innerHTML += productHTML;
                });
    
                attachEventListeners(); // เพิ่ม event ให้ปุ่มที่สร้างใหม่
                updateTotal();
            }
    
            // 3️⃣ ฟังก์ชันอัปเดตราคาทั้งหมด
            function updateTotal() {
                let total = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
                totalElement.textContent = `TOTAL : $ ${total}`;
            }
    
            // 4️⃣ ฟังก์ชันเพิ่ม event ให้ปุ่ม + และ -
            function attachEventListeners() {
                document.querySelectorAll(".product-card").forEach(card => {
                    const id = parseInt(card.dataset.id);
                    const decreaseBtn = card.querySelector(".decrease");
                    const increaseBtn = card.querySelector(".increase");
                    const quantityElement = card.querySelector(".quantity");
    
                    decreaseBtn.addEventListener("click", function () {
                        let item = cartItems.find(product => product.product_id === id);
                        if (item.quantity > 1) {
                            item.quantity--;
                            quantityElement.textContent = item.quantity;
                           
                        }
                        else {
                            // ลบสินค้าจากตะกร้าและฐานข้อมูลเมื่อจำนวนสินค้าถึง 1
                            const confirmDelete = confirm("Do you want delete this product ?");
                            if (confirmDelete) {
                                removeItemFromCart(id);
                            }
                        }
                        updateTotal();
                    });
    
                    increaseBtn.addEventListener("click", function () {
                        let item = cartItems.find(product => product.product_id === id);
                        item.quantity++;
                        quantityElement.textContent = item.quantity;
                        updateTotal();
                    });
                });
            }

            function removeItemFromCart(productId) {
            // ส่งคำขอลบสินค้าจากฐานข้อมูลไปที่ server
            fetch(`/remove-item?customer_id=<%= customer_id %>&product_id=${productId}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ลบสินค้าจาก cartItems
                    const itemIndex = cartItems.findIndex(item => item.product_id === productId);
                    if (itemIndex > -1) {
                        cartItems.splice(itemIndex, 1);  // ลบสินค้าออกจาก array
                    }
                    renderCart();  // รีเรนเดอร์ใหม่ให้หน้าจอแสดงสินค้าใหม่
                    updateTotal(); // อัปเดตยอดรวม
                } else {
                    alert("เกิดข้อผิดพลาดในการลบสินค้า");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์");
            });

        }
    
            // 5️⃣ เรียก renderCart() ครั้งแรกเพื่อแสดงสินค้า
            renderCart();
        });

        
  
    

    //LOGOUT
    function logout(event) {
        event.preventDefault(); // ป้องกันเปลี่ยนหน้าอัตโนมัติ
        const confirmLogout = confirm("Do you want to Logout ?");
        if (confirmLogout) {
            window.location.href = "/signin"; // ไปที่หน้า Sign In
        }
    }

    function goToPayment() {
        window.location.href = "/payment-address?customer_id=<%= customer_id %>";
    }


</script>

   
</body>
</html>
